{% extends 'base.html' %}

{% block header %}
<h2>{% block title %}Download Youtube Video:{% endblock %}</h2>
<div class="right">
    <div>
        <label class="gray" for="video_dir">Save video to: </label>
        <input class="gray" id="video_dir" name="video_dir" value="{{ video_dir }}" onfocusout="folder_input(event)"/>
        <select class="gray" style="width:26px" onchange="folder_selected(event)">
            {% for folder in video_folders %}
            <option value={{ folder }}>{{ folder }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label class="gray" for="audio_dir">Save audio to: </label>
        <input class="gray" id="audio_dir" name="audio_dir" value="{{ audio_dir }}" onfocusout="folder_input(event)"/>
        <select class="gray" style="width:26px" onchange="folder_selected(event)">
            {% for folder in audio_folders %}
            <option value={{ folder }}>{{ folder }}</option>
            {% endfor %}
        </select>
    </div>
</div>
{% endblock %}

{% block content %}
<form action="javascript:start_task()" method="post">
    <h3>Youtube Url:</h3>
    <input type="url" name="youtube_url" value="" id="youtube_url" onchange="close_selection()" style="margin-left: 0" required>
    <h3>Options:</h3>
    <table>
        <tr>
            <th width="50%"><label class="gray">Select Video or Audio only.</label></th>
            <th width="50%"><label class="gray" for="playlist_items">Playlist items:</label></th>
        </tr>
        <tr>
            <td>
                <div>
                    <input type="radio" id="video" name="output_type" value="video" checked/>
                    <label class="radio" for="video">Video</label>
                    <input type="radio" id="audio" name="output_type" value="audio"/>
                    <label class="radio" for="audio">Audio</label>
                </div>
            </td>
            <td>
                <input type="text" name="playlist_items" placeholder="e.g. 1:3,7,-5::2" id="playlist_items">
            </td>
        </tr>
        <tr>
            <th><label class="gray">Select Video resolution.</label></th>
            <th><label class="gray">Select Audio quality.</label></th>
        </tr>
        <tr>
            <td>
                <div>
                    <input type="radio" id="high" name="resolution" value="1080"/>
                    <label class="radio" for="high">1080</label>
                    <input type="radio" id="mid" name="resolution" value="720" checked/>
                    <label class="radio" for="mid">720</label>
                    <input type="radio" id="low" name="resolution" value="480"/>
                    <label class="radio" for="low">480</label>
                </div>
                <select class="advanced gray" id="video_select" style="width:100%; display: none">
                    <option value="" selected>See detailed video list:</option>
                    {% for r in resolutions %}
                    <option id="video_formats" value={{ r }}>{{ r }}</option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <input type="radio" id="best" name="quality" value="best" checked/>
                <label class="radio" for="best">best</label>
                <input type="radio" id="worst" name="quality" value="worst"/>
                <label class="radio" for="worst">low</label>
                <select class="advanced gray" id="audio_select" style="width:100%; display:none">
                    <option value="" selected>See detailed audio list:</option>
                    {% for q in qualities %}
                    <option id="audio_formats" value={{ q }}>{{ q }}</option>
                    {% endfor %}
                </select>
            </td>
        </tr>
    </table>
    <div>
        <button type="submit" formaction="javascript:toggle_advanced()">Advanced</button>
        <button type="submit">Submit</button>
    </div>
</form>
<div id="prog"></div>
<script>
    $("#prog").load("/progress");

    let intervalId = -1;
    update();

    function update() {
        if (intervalId !== -1)
            return
        intervalId = setInterval(function() {
            $("#prog").load("/progress");
            setTimeout(function() {
                let progressing = document.getElementById("progressing").innerText;
                console.log("refreshing " + progressing);
                if (progressing === "False") {
                    clearInterval(intervalId);
                    intervalId = -1;
                }
            }, 5000);
        }, 1000);
    }

    function toggle_advanced() {
        let fetch_formats = false;
        let elements = document.getElementsByClassName("advanced");
        for (let i = 0; i < elements.length; i++) {
            if (elements[i].style.display === "block") {
                elements[i].style.display = "none";
            } else {
                elements[i].style.display = "block";
                fetch_formats = true;
            }
        }
        clean_selection("video_select");
        clean_selection("audio_select");
        if (fetch_formats) {
            $.post("/fetch_formats", {'url': document.getElementById("youtube_url").value}, function(data) {
                console.log("video formats = " + data.videos);
                console.log("audio formats = " + data.audios);
                add_selection("video_select", data.videos);
                add_selection("audio_select", data.audios);
            })
        }
    }

    function close_selection() {
        let elements = document.getElementsByClassName("advanced");
        for (let i = 0; i < elements.length; i++) {
            elements[i].style.display = "none";
        }
        clean_selection("video_select");
        clean_selection("audio_select");
    }

    function clean_selection(id) {
        let select = document.getElementById(id);
        let options = select.options;
        for (let i = options.length - 1; i >= 1; i--) {
            select.remove(i);
        }
    }

    function add_selection(id, list) {
        let select = document.getElementById(id);
        for (let i = 0; i < list.length; i++) {
            select.options.add(new Option(list[i], list[i]));
        }
    }

    function start_task() {
        let url = document.getElementById("youtube_url").value
        let video_select = document.getElementById("video_select");
        let audio_select = document.getElementById("audio_select");
        let resolution = document.querySelector('input[name="resolution"]:checked').value
        let quality = document.querySelector('input[name="quality"]:checked').value
        if (video_select.value) resolution = video_select.value;
        if (audio_select.value) quality = audio_select.value;
        console.log("Starting task: " + url);

        const json_data = {
            "url": url,
            "output_type": document.querySelector('input[name="output_type"]:checked').value,
            "quality": quality,
            "resolution": resolution,
            "playlist_items": document.getElementById("playlist_items").value,
            "action": "start"
        };
        $.post("/task_maker", json_data, function(response) {
            if (response.code === 200) {
                console.log("Started task: " + url);
            } else {
                window.alert(response.message);
            }
            update();
        });
    }

    function switch_task(event) {
        let url = event.target.value
        let action = event.target.innerText.toLowerCase()
        console.log(action + " task: " + url);
        const json_data = {
            "url": url,
            "action": action,
        }
        $.post("/task_maker", json_data, function(response) {
            if (response.code === 200) {
                console.log("Done " + action + " task: " + url);
            } else {
                window.alert(response.message);
            }
            update();
        });
    }

    function clear_completed() {
        console.log("Clear tasks");
        const json_data = {
            "action": "clear"
        }
        $.post("/task_maker", json_data, function(response) {
            if (response.code === 200) {
                console.log("Clear completed tasks");
            } else {
                window.alert(response.message);
            }
            update();
        });
    }

    function stop_all() {
        console.log("Stop all tasks");
        const json_data = {
            "action": "stop_all"
        }
        $.post("/task_maker", json_data, function(response) {
            if (response.code === 200) {
                console.log("Stopped all ongoing tasks");
            } else {
                window.alert(response.message);
            }
            update();
        });
    }

    function show_error(event) {
        window.alert(event.target.value)
    }
</script>
{% endblock %}
